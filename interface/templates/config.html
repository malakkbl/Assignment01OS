{% extends "base.html" %}
{% block content %}
<h1 class="title">Hi {{session.username}}!</h1>
<h2 class="subtitle">Configure your simulation</h2>

<form id="cfgForm" method="post">
  <!-- Algorithm dropdown -->
  <div class="field">
    <label class="label">Algorithm</label>
    <div class="select">
      <select name="algorithm" id="algoSel" onchange="toggleExtra()">
        {% for key,(name,_,needP,needQ) in algos.items() %}
          <option value="{{key}}" data-needprio="{{needP}}" data-needq="{{needQ}}">
              {{name}}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Quantum / context-switch inputs -->
  <div id="qBox" class="field is-hidden">
    <label class="label">Time quantum</label>
    <input class="input" type="number" name="quantum" value="4" min="1">
  </div>
  <div id="ctxBox" class="field is-hidden">
    <label class="label">Context-switch time</label>
    <input class="input" type="number" name="ctx" value="0" min="0">
  </div>

  <!-- Processes table -->
  <h3 class="subtitle">Processes</h3>
  <table class="table is-striped" id="procTbl">
    <thead>
      <tr><th>PID</th><th>Arrival</th><th>Burst</th><th class="prioCol">Priority</th></tr>
    </thead><tbody></tbody>
  </table>
  <button type="button" class="button" onclick="addRow()">＋ Add process</button>
  <input type="hidden" name="proc_json" id="procJson">
  <br><br>
  <button class="button is-primary">View results ▶️</button>
</form>

<script>
let pid=1; addRow();
function addRow(){
  const t=document.querySelector('#procTbl tbody');
  t.insertAdjacentHTML('beforeend',`
    <tr>
      <td>${pid}</td>
      <td><input class="input arr"  type="number" min="0" value="0"></td>
      <td><input class="input bur"  type="number" min="1" value="1"></td>
      <td class="prioCol"><input class="input pri" type="number" min="0" value="0"></td>
    </tr>`); pid++;
}
function toggleExtra(){
  const opt=document.querySelector('#algoSel').selectedOptions[0];
  const needQ=opt.dataset.needq==="True", needP=opt.dataset.needprio==="True";
  document.getElementById('qBox').classList.toggle('is-hidden',!needQ);
  document.getElementById('ctxBox').classList.toggle('is-hidden',!(needQ && opt.value.startsWith('prio')));
  document.querySelectorAll('.prioCol').forEach(el=>el.style.display=needP?'table-cell':'none');
}
toggleExtra();
document.getElementById('cfgForm').addEventListener('submit',e=>{
  const rows=[...document.querySelectorAll('#procTbl tbody tr')];
  const procs=rows.map(r=>({
      pid:parseInt(r.children[0].innerText),
      arrival_time:+r.querySelector('.arr').value,
      burst_time:+r.querySelector('.bur').value,
      priority:+(r.querySelector('.pri')?.value||0)
  }));
  document.getElementById('procJson').value=JSON.stringify(procs);
});
</script>
{% endblock %}
