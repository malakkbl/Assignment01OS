{% extends "base.html" %}
{% block content %}
<h1 class="title">CPU Scheduler Simulator</h1>

<form id="procForm" method="post" action="/run">
  <div class="field">
    <label class="label">Algorithm</label>
    <div class="control">
      <div class="select">
        <select name="algorithm" id="algoSelect" onchange="toggleExtra()">
          {% for key, (name, _, need_prio, need_q) in algos.items() %}
            <option value="{{key}}" data-needprio="{{need_prio}}" data-needq="{{need_q}}">
              {{name}}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div id="quantumBox" class="field is-hidden">
    <label class="label">Time quantum</label>
    <input class="input" type="number" name="quantum" value="4" min="1">
  </div>
  <div id="ctxBox" class="field is-hidden">
    <label class="label">Context-switch time</label>
    <input class="input" type="number" name="ctx" value="0" min="0">
  </div>

  <h2 class="subtitle">Processes</h2>
  <table class="table is-striped" id="procTable">
    <thead><tr><th>PID</th><th>Arrival</th><th>Burst</th><th class="prioCol">Priority</th></tr></thead>
    <tbody></tbody>
  </table>
  <button type="button" class="button" onclick="addRow()">Add process</button>
  <input type="hidden" name="proc_json" id="procJson">
  <br><br>
  <button class="button is-primary">Run simulation</button>
</form>

<script>
let pid = 1;
addRow();
function addRow(){
  const tbody = document.querySelector("#procTable tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
     <td>${pid}</td>
     <td><input type="number" min="0" value="0" class="input arrival"></td>
     <td><input type="number" min="1" value="1" class="input burst"></td>
     <td class="prioCol"><input type="number" min="0" value="0" class="input prio"></td>`;
  tbody.appendChild(tr); pid++;
}
function toggleExtra(){
  const sel   = document.querySelector("#algoSelect");
  const opt   = sel.selectedOptions[0];
  const needQ = opt.dataset.needq === "True";
  const needP = opt.dataset.needprio === "True";
  document.getElementById("quantumBox").classList.toggle("is-hidden", !needQ);
  document.getElementById("ctxBox").classList.toggle("is-hidden", !(needQ && opt.value.includes('priority')));
  // hide/show priority column
  document.querySelectorAll(".prioCol").forEach(el=>el.style.display = needP?'table-cell':'none');
}
toggleExtra();

document.getElementById("procForm").addEventListener("submit", e=>{
  const rows = [...document.querySelectorAll("#procTable tbody tr")];
  const proc = rows.map(r=>({
        pid:        parseInt(r.children[0].innerText),
        arrival_time: parseInt(r.querySelector('.arrival').value),
        burst_time: parseInt(r.querySelector('.burst').value),
        priority:     parseInt(r.querySelector('.prio')?.value||0)
  }));
  document.getElementById("procJson").value = JSON.stringify(proc);
});
</script>
{% endblock %}
